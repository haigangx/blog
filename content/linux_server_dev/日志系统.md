# 日志

## Linux系统日志体系图

![Linux系统日志图](doc/linux_sys_log.png)

linux系统日志由守护进程syslogd(最新Linux系统一般是rsyslogd)处理，rsyslogd守护进程既能接受用户进程输出的日志，又能接受内核日志。

- 用户进程通过调用syslog函数生成系统日志，该函数将日志输出到/dev/log中，rsyslogd监听此文件以获取用户进程的日志输出
- 内核日志由printk等函数打印至内核的环状缓存(ring buffer)中，环状缓存去的内容直接映射到/proc/kmsg文件中，rsyslogd通过读取该文件获得内核日志

rsyslogd守护进程接收到用户进程或内核输入的日志后，会将它们输出至特定的日志文件。默认情况下，调试信息保存到/var/log/debug文件，普通信息保存到/var/log/messages中，内核消息则保存到/var/log/kern.log中，rsyslogd的主配置文件是/etc/rsyslog.conf

## 日志相关函数：

### syslog

```
#include <syslog.h>
void syslog(int priority, const char* message, ...);
```
- priority：设施值与日志级别的按位或,设施的默认值为LOG_USER，设施值在大多数情况下都为这一种，日志级别有如下几种情况：

  ```
  #include <syslog.h>
  #define LOG_EMERG       0 //系统不可用
  #define LOG_ALERT       1 //报警，需要立即采取动作
  #define LOG_CRIT        2 //非常严重的情况
  #define LOG_ERR         3 //错误
  #define LOG_WARNING     4 //警告
  #define LOG_NOTICE      5 //通知
  #define LOG_INFO        6 //信息
  #define LOG_DEBUG       7 //调试
  ```
- message和...参数用于格式化输出，和printf类似

### openlog

openlog函数可以改变syslog的默认输出方式，进一步结构化日志内容：

```
#include <syslog.h>
void openlog(const char* ident, int logopt, int facility);
```

- ident：参数指定的字符串将被添加到日志消息的日期和时间之后，通常设置为程序的名字
- logopt：为后续syslog调用的行为进行配置，可取为下列值得按位或：
  ```
  #define LOG_PID         0x01    //日志消息中包含程序PID
  #define LOG_CONS        0x02    //如果消息不能记录到日志文件，则打印至终端
  #define LOG_ODELAY      0x04    //延迟打开日志功能直到第一次调用syslog
  #define LOG_NDELAY      0x08    //不延迟打开日志功能
  ```
- facility：可以用来修改syslog函数中的默认设施值

### setlogmask

setlogmask函数用来设置日志掩码，日志级别大于日志掩码的日志信息会被系统忽略

程序在开发阶段可能需要输出很多调试信息，而发布之后我们又需要将这些调试信息关闭，这时候就需要日志过滤功能

```
#include <syslog.h>
int setlogmask(int maskpri);
```
- maskpri：指定日志掩码值，返回调用进程先前的日志掩码值，该函数始终会成功

### closelog

closelog函数用来关闭日志功能：

```
#include <syslog.h>
void closelog();
```
