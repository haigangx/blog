# ARP协议工作原理

<!-- TOC -->

- [一、工作原理](#一工作原理)
- [二、ARP 请求/应答报文详解](#二arp-请求应答报文详解)
- [三、ARP 高速缓存](#三arp-高速缓存)
- [四、用 tcpdump 观察 ARP 通信过程](#四用-tcpdump-观察-arp-通信过程)

<!-- /TOC -->

## 一、工作原理

ARP 协议属于数据链路层的协议，它能实现从 IP 地址到以太网 MAC 地址的转换

它的工作原理是：主机向自己所在的网络广播一个 ARP 请求，该请求包含目标机器的网络地址。此网络上的其他机器都将收到这个请求，但只有被请求的目标机器会回应一个 ARP 应答，其中包含自己的物理地址

## 二、ARP 请求/应答报文详解

ARP 请求/应答报文格式如下：

<div align="center"><image src="../doc/ARP报文格式.png"></image></div>

- 硬件类型：定义物理地址的类型，为 1 表示 MAC 地址
- 协议类型：表示要映射的协议地址类型，值为 0x800 表示 IP 地址
- 硬件地址长度和协议地址长度：单位为字节，对 MAC 地址来说，其长度为 6；对 IP 地址来说，其长度为 4
- 操作：有四种操作类型：ARP 请求(1)、ARP 应答(2)、RARP 请求(3)、RARP 应答(4)
- 最后四个字段指定通信双方的以太网地址和IP地址
  - 发送端填充除目的端以太网地址外的其他 3 个字段，以构建 ARP 请求并发送之
  - 接收端发现该请求的目的端 IP 地址是自己，就把自己的以太网地址填进去，然后交换两个目的端地址和两个发送端地址，以构建 ARP 应答并返回之


> Note！：ARP 报文长度为 28 字节，再加上以太网帧头部和尾部的 18 字节，则一个携带 ARP 报文的以太网帧总长度为 46 字节，但是有些实现要求以太网帧数据部分长度至少为 46 字节，所以这时需要对 ARP 报文进行一些填充以满足要求，这种情况下，一个携带 ARP 报文的以太网帧总长度为 64 字节。

## 三、ARP 高速缓存

通常，ARP 会维护一个高速缓存，其中包含经常访问（如网关地址）或最近访问的机器的 IP 地址到物理地址的映射，这样可以避免重复进行 ARP 请求，提高了发送数据包的速度

Linux 下可以使用 `arp -a` 命令来查看和修改 ARP 高速缓存，其输出如下：

```
_gateway (192.168.0.1) at cc:2d:21:11:4a:68 [ether] on wlp8s0
? (169.254.169.254) at <incomplete> on wlp8s0
? (192.168.0.100) at 48:2c:a0:5e:fb:e3 [ether] on wlp8s0
```

分别对应三条 ARP 高速缓存，还可以对这些缓存进行删除和添加：

```
# 删除一条 ARP 缓存项
sudo arp -d 192.168.0.100
# 添加一条 ARP 缓存项
sudo arp -s 192.168.0.100 48:2c:a0:5e:fb:e3
```

## 四、用 tcpdump 观察 ARP 通信过程

为了清楚的了解 ARP 的运作过程，我们可以对上面 `arp -a` 的输出结果中 `192.168.0.100` 地址执行 `telnet` 命令，并使用 `tcpdump` 抓取这个过程中两个 IP 地址之间交换的以太网帧

使用之前，先删除 ARP 高速缓存中的对应项：

```
sudo arp -d 192.168.0.100
```

然后，使用 `tcpdump` 命令进行抓包：

```
sudo tcpdump -i wlp8s0 -ent '(dst 192.168.0.100 and src 192.168.0.103) or (dst 192.168.0.103 and src 192.168.0.100)'
```

接下来，重新打开一个终端，使用 `telnet` 登录上面的 IP（不用管是否登录成功）：

```
telnet 192.168.0.100
```

在抓包的终端中，我们只取前面的两条输出，如下：

```
74:de:2b:a3:40:f1 > ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 42: Request who-has 192.168.0.100 tell 192.168.0.103, length 28
48:2c:a0:5e:fb:e3 > 74:de:2b:a3:40:f1, ethertype ARP (0x0806), length 42: Reply 192.168.0.100 is-at 48:2c:a0:5e:fb:e3, length 28
```

- 第一个数据包中，ARP 通信的源端物理地址为 `74:de:2b:a3:40:f1`，即为本地 MAC 地址，目的端物理地址为以太网的广播地址 `ff:ff:ff:ff:ff:ff`，整个局域网内的机器都会收到并处理这条帧。数值 `0x806` 是以太网帧头部的类型字段的值，表示分用的目标是 ARP 模块。该以太网帧的长度为 `42` 字节（实际为 46 字节，tcpdump 未统计以太网帧尾部 4 字节的 CRC 字段），其中数据部分长度为 `28` 字节。`Request` 表示这是一个 ARP 请求， `who-has 192.168.0.100 tell 192.168.0.103` 表示 192.168.0.103 要查询 192.168.0.100 的 MAC 地址
- 第二个数据包中，ARP 通信的源端物理地址为 `48:2c:a0:5e:fb:e3`，目的端物理地址为 `74:de:2b:a3:40:f1`。`Reply` 表示这是一个 ARP 应答，`192.168.0.100 is-at 48:2c:a0:5e:fb:e3` 则表示目标机器 192.168.0.100 报告其物理地址
