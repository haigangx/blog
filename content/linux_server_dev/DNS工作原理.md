# DNS 工作原理

<!-- TOC -->

- [一、DNS 服务](#一dns-服务)
    - [1. 简介](#1-简介)
    - [2. 域名的层级](#2-域名的层级)
    - [3. DNS 解析过程](#3-dns-解析过程)
- [二、DNS 报文](#二dns-报文)
- [三、Linux 下访问 dns 服务](#三linux-下访问-dns-服务)
- [四、使用 tcpdump 观察 DNS 通信过程](#四使用-tcpdump-观察-dns-通信过程)

<!-- /TOC -->

## 一、DNS 服务

### 1. 简介

我们访问因特网上的网站时，便于记忆经常使用域名而不是 IP 地址，这就需要机器将域名转换为 IP 地址，所以就需要域名查找服务，域名查找服务有 NIS(Network Information Service，网络信息服务)、DNS 和本地静态文件等。这里主要讨论 DNS。

可以把 DNS 想象成一本巨大的电话本，比如当你要访问域名 `www.163.com`，首先要通过 DNS 查出它的 IP 地址是 `183.6.248.87`

### 2. 域名的层级

在明白 DNS 解析过程前，先要了解域名的层级：

- 根域名：`.root` 或者 `.`，通常是省略的
- 顶级域名：`.com`，`.cn` 等
- 次级域名：如 `google.com` 里面的 `google`，用户可以进行注册购买
- 主机域名：如 `baike.baidu.com` 里面的 `baike`，这个是用户可分配的

> 主机名.次级域名.顶级域名.根域名 baike.baidu.com.root

<div align="center"><image src="../doc/DNS域名服务器分级.jpg"></image></div>

### 3. DNS 解析过程

以访问 `www.163.com` 这个域名为例：

- 先查找本地 **DNS 缓存**（自己的电脑上），有则返回，没有则进入下一步
- 查看本地 **hosts 文件** 有没有相应的映射记录，有则返回，没有则进入下一步
- 向 **本地 DNS 服务器** （一般都是你的网络接入服务器商提供，比如中国电信，中国移动）发送请求进行查询，本地DNS服务器收到请求后，会先查下自己的缓存记录，如果查到了直接返回就结束了，**如果没有查到，本地DNS服务器就会向DNS的根域名服务器发起查询请求**：请问老大， www.163.com 的ip是啥？
- 根域名服务器收到请求后，看到这是个 .com 的域名，就回信说：这个域名是由 **.com** 老弟管理的，你去问他好了，这是.com老弟的联系方式（ip1）。
- 本地 DNS 服务器接收到回信后，照着老大哥给的联系方式（ip1），马上给 .com 这个顶级域名服务器发起请求：请问 .com 大大，www.163.com 的ip 是啥？
- .com 顶级域名服务器接收到请求后，看到这是 **163.com** 的域名，就回信说：这个域名是 .163.com 老弟管理的，你就去问他就行了，这是他的联系方式（ip2）
- 本地 DNS 服务器接收到回信后，按照前辈的指引（ip2），又向 .163.com 这个权威域名服务器发起请求：请问 163.com 大大，请问 www.163.com 的ip是啥？
- 163.com 权威域名服务器接收到请求后，确认了是自己管理的域名，马上查了下自己的小本本，**把 www.163.com 的ip告诉了 本地DNS服务器**
- 本地DNS服务器接收到回信后，非常地开心，这下总算拿到了www.163.com的ip了，马上把这个消息告诉了要求查询的客户（就是你的电脑）。由于这个过程比较漫长，本地DNS服务器为了节省时间，也为了尽量不去打扰各位老大哥，就 **把这个查询结果记在了自己的 DNS 缓存中**，方便下次有人来查询时，可以快速回应

下图是访问 `www.google.com` 的过程图，和上述过程相同：

<div align="center"><image src="../doc/DNS域名服务器解析过程.gif"></image></div>


## 二、DNS 报文

DNS 是一套分布式的域名服务系统。每个 DNS 服务器上都存放着大量的机器名和 IP 地址的映射，并且是动态更新的。众多网络客户端程序都使用 DNS 协议来向 DNS 服务器查询目标主机的 IP 地址

DNS 查询和应答报文的格式如下：

<div align="center"><image src="../doc/DNS报文格式.png"></image></div>

- `16 位标识` 字段用于标记一对 DNS 查询和应答，以此区分一个 DNS 应答是哪个 DNS 查询的 回应
- `16 位标志` 字段用于协商具体的通信方式和反馈通信状态，具体细节如下图：

  <div align="center"><image src="../doc/DNS报文头部的标志字段.png"></image></div>

  - `QR`：查询/应答标志。0 表示查询报文，1 表示应答报文
  - `opcode`：定义查询和应答的类型。0 表示标准查询，1 表示反向查询（由 IP 地址获得主机域名），2 表示请求服务器状态
  - `AA`：授权应答标志，仅由应答报文使用。1 表示域名服务器是授权服务器
  - `TC`：截断标志，仅当 DNS 报文使用 UDP 服务时使用。因为 UDP 数据报有长度限制，所以过长的 DNS 报文将被截断。1 表示 DNS 报文超过 512 字节，并被截断
  - `RD`：递归查询标志。
    - 1 表示致性递归查询，即如果目标 DNS 服务器无法解析某个主机名，则它将向其他 DNS 服务器继续查询，如此递归，直到获得结果并把该结果返回给客户端
    - 0 表示致性迭代查询，即如果目标 DNS 服务器无法解析某个主机名，则它将自己知道的其他 DNS 服务器的 IP 地址返回给客户端，供客户端参考
  - `RA`：允许递归标志。仅由应答报文使用，1 表示 DNS 服务器支持递归查询
  - `zero`：这 3 位未用，设置为 0
  - `rcode`：4 位返回码，表示应答的状态。常用值有 0（无错误）和 3（域名不存在）
- `下来的 4 个字段` 分别指出 DNS 报文最后 4 个字段的资源记录数目
  - 对查询报文而言，它一般包含 1 个查询问题，而应答资源记录数、授权资源记录数、额外资源记录数则为 0
  - 应答报文的应答资源记录数则至少为 1，而授权资源记录数和额外资源记录数可为 0 或非 0
- `查询问题` 的格式如下：

  <div align="center"><image src="../doc/DNS查询问题的格式.png"></image></div>

  - `查询名` 以一定的格式封装了要查询的主机域名
  - `16位查询类型` 表示如何执行查询操作，常见类型如下：
    - 类型 A，值为 1，表示获取目标主机的 IP 地址
    - 类型 CNAME，值为 5，表示获得目标主机的别名
    - 类型 PTR，值为 12，表示反向查询
  - `16位查询类` 通常为 1，表示获取因特网地址（IP 地址）
- `应答、授权和额外信息字段` 都使用资源记录 (Resource Record, RR) 格式，格式如下图：

  <div align="center"><image src="../doc/资源记录格式.png"></image></div>

  - `32 位域名` 是该记录中与资源对应的名字，其格式和查询问题中的查询名字段相同
  - `16 位类型` 和 `16 位类` 字段的含义和 DNS 查询问题的对应字段相同
  - `32 位生存时间` 表示该查询记录结果可被本地客户端程序缓存多长时间，单位为秒
  - `16 位资源数据长度` 和 `资源数据` 字段的内容取决于类型字段：对类型 A 而言，资源数据是 32 位的 IPv4 地址，而资源数据长度则为 4 字节

## 三、Linux 下访问 dns 服务

Linux 使用 `/etc/resolv.conf` 文件来存放 DNS 服务器的 IP 地址：

```
nameserver 127.0.0.53
```

上面文件内容中的 IP 地址是首选 DNS 服务器地址

可以通过 `host` 命令访问 DNS 服务器：

```
host -t A www.baidu.com
www.baidu.com is an alias for www.a.shifen.com.
www.a.shifen.com has address 14.215.177.39
www.a.shifen.com has address 14.215.177.38
```

- `host` 命令的输出说明：机器名 `www.baidu.com` 是 `www.a.shifen.com.` 的别名，并且该机器名对应两个 IP 地址
- `host` 命令使用 DNS 协议和 DNS 服务器通信，其 `-t` 选项告诉 DNS 协议使用哪种查询类型，这里使用 `A` 类型，即通过机器的域名查找其 IP 地址

## 四、使用 tcpdump 观察 DNS 通信过程

我们在本地机器上运行 `host` 命令以查询主机 `www.baidu.com` 的 IP 地址，并使用 `tcpdump` 抓取这一过程中 LAN 上传输的以太网帧

```
sudo tcpdump -i wlp8s0 -nt -s 500 port domain
```

> 使用 `port domain` 来过滤数据包，表示只抓取使用 domain 域名服务的数据包，即 DNS 查询和应答报文

重开一个终端，执行：

```
host -t A www.baidu.com
```

`tcpdump` 的输出如下：

```
IP 192.168.0.103.55203 > 192.168.0.1.53: 32781+ A? www.baidu.com. (31)
IP 192.168.0.1.53 > 192.168.0.103.55203: 32781 3/5/5 CNAME www.a.shifen.com., A 14.215.177.38, A 14.215.177.39 (260) 
```

> IP 指后面的内容描述的是 IP 数据包
> tcpdump 以 “IP 地址.端口号” 描述通信的某一端：以 “>” 表示数据传输的方向，“>” 前面是源端，后面是目的端
> 53 是 DNS 服务器使用的端口

- 第一个数据包中：
  - 数值 `32781` 表示 DNS 查询报文的标识值，该值也出现在 DNS 应答报文中，用来标识一对 DNS 查询应答
  - 数值后的 `+` 表示启用递归查询标志
  - `A?` 表示使用 A 类型的查询方式
  - `www.baidu.com` 是 DNS 查询问题中的查询名
  - 查询报文长度为 `31` 字节
- 第二个数据包中：
  - `3/5/5` 表示该报文中包含 3 个应答资源记录、5 个授权资源记录、5个额外信息记录
  - `CNAME www.a.shifen.com, A 14.215.177.38, A 14.215.177.39` 表示 3 个应答资源记录的内容，其中 CNAME 后跟机器别名，A 后表示 IP 地址
  - 该应答报文长度为 `226` 字节


