# tcpdump

tcpdump是一款经典的网络抓包工具，它的常见选项如下：
-n 使用IP地址表示主机，而不是主机名；使用数字表示端口号，而不是服务名称
-i 指定要监听的网卡接口。"-i any"表示抓取所有网卡接口上的数据包
-v 输出比较详细的信息，比如，显示IP数据包中的TTL和TOS信息
-t 不打印时间戳
-e 显示以太网帧头部信息
-c 仅抓取指定数量的数据包
-x 以十六进制数显示数据包的内容，但不显示包中以太网帧的头部信息
-X 与-x选项类似，不过还打印每个十六进制字节对应的ASCII字符
-XX 与-X相同，不过还打印以太网帧的头部信息
-s 设置抓包时的抓取长度。当数据包的长度超过抓取长度时，tcpdump抓取到的将是被截断的数据包。在4.0以及以前的版本中，默认的抓包长度是68字节。这对于IP、TCP和UDP等协议已经足够了，但对于像DNS、NFS这样的协议，68字节通常不能通纳一个完整的数据包。不过4.0之后的版本，默认的抓包长度被修改为65535字节，因此基本不用担心抓包长度的问题
-S 以绝对值显示TCP报文段的序号，而不是相对值
-w 将tcpdump的输出以特殊的格式定向到某个文件
-r 从文件读取数据包信息并显示之

tcpdump还支持用表达式进一步过滤数据包。tcpdump表达式的操作数分为3种：类型(type)、方向(dir)和协议(proto)，下面依次介绍：
* 类型，解释其后面紧跟着的参数的含义。tcpdump支持的类型包括host、net、port和portrange。它们分别指定主机名(或IP地址)，用CIDR方法表示的网络地址，端口号以及端口范围
  例如：要抓取1.2.3.0/255.255.255.0网络上的数据包，可以使用如下命令：
  $ tcpdump net 1.2.3.0/24
* 方向，src指定数据包的发送端，dst指定数据包的目的端
  比如：要抓取进入端口13579的数据包：
  $ tcpdump dst port 13579
* 协议，指定目标协议
  比如：要抓取所有ICMP数据包：
  $ tcpdump icmp
  
还可以使用逻辑操作符来组织上述操作数以创建更复杂的表达式。
tcpdump支持的逻辑操作符包括and(或&&)、or(或||)、not(或!)
例如：抓取主机ernest-laptop和所有非Kongming20的主机之间交换的IP数据包：
  $ tcpdump ip host ernest-laptop and not Kongming20

如果表达式比较复杂，可以使用括号将他们分组，不过在使用括号时，要么使用反斜杠"\"对它转义，要么用单引号"'"，以避免它被shell所解释
例如：要抓取来自主机10.0.2.4，目标端口是3389或22的数据包：
  $ tcpdump 'src 10.0.2.4 and (dst port 3389 or 22)'

tcpdump还允许直接使用数据包中的部分协议字段的内容来过滤数据包
例如：仅抓取TCP同步报文段：
  $ tcpdump 'tcp[13] & 2 != 0'
  这是因为TCP头部的第14个字节的第2个位正是同步标志，该命令还可以表示为：
  $ tcpdump 'tcp[tcpflags] & tcp-syn != 0'

更多用法参考tcpdump的man手册
